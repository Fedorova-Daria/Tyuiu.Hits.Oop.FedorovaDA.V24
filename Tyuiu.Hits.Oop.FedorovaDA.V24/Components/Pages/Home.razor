@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Text.RegularExpressions
@using NewsAggregator.Data
@using NewsAggregator.Models
@using Tyuiu.Hits.Oop.FedorovaDA.V24.Models
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

@attribute [Authorize]

<PageTitle>Главная</PageTitle>

<div class="container-fluid">
    <div class="row">
        
        <!-- ЛЕВАЯ КОЛОНКА: Меню -->
        <div class="col-md-3 mb-4">
            <div class="sticky-sidebar">
                <!-- Основные разделы -->
                <div class="list-group mb-4 shadow-sm">
                    <button class="list-group-item list-group-item-action fw-bold @(currentMode == FeedMode.MyFeed ? "active" : "")" 
                            @onclick="() => SetMode(FeedMode.MyFeed)">
                        ❤️ Моя лента
                    </button>
                    <button class="list-group-item list-group-item-action fw-bold @(currentMode == FeedMode.AllNews ? "active" : "")" 
                            @onclick="() => SetMode(FeedMode.AllNews)">
                        🌍 Все новости
                    </button>
                    <button class="list-group-item list-group-item-action fw-bold @(currentMode == FeedMode.Favorites ? "active" : "")" 
                            @onclick="() => SetMode(FeedMode.Favorites)">
                        ⭐ Избранное
                    </button>
                </div>

                <!-- Блок Источников -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
                        Источники
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var src in sources)
                        {
                            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(currentMode == FeedMode.BySource && selectedSourceId == src.Id ? "active" : "")"
                                    @onclick="() => FilterBySource(src.Id)">
                                @src.Name
                                
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- ПРАВАЯ КОЛОНКА: Лента новостей -->
        <div class="col-md-9">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>@GetTitle()</h3>
                <button class="btn btn-outline-primary" @onclick="PrepareAndOpenModal">
    📂 Выбрать категорию
</button>
            </div>

            @if (currentMode == FeedMode.MyFeed && myInterestIds.Count == 0)
            {
                <div class="alert alert-warning">
                    У вас пока нет интересов. <a href="settings">Перейдите в настройки</a>.
                </div>
            }

            @if (articles == null)
            {
                <p><em>Загрузка новостей...</em></p>
            }
            else if (articles.Count == 0)
            {
                <div class="alert alert-info">
                    В этом разделе пока пусто.
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var item in articles)
                    {
                        var imgUrl = GetImageUrl(item.Description);
                        var cleanDesc = GetCleanDescription(item.Description);
                        
                        // Проверяем статусы
                        bool isBookmarked = bookmarkedArticleIds.Contains(item.Id);
                        bool isRead = readArticleIds.Contains(item.Id);

                        <div class="col-md-12 mb-4">
                            <!-- Добавляем прозрачность, если прочитано -->
                            <div class="card h-100 shadow-sm @(isRead ? "opacity-75 bg-light" : "")" style="transition: opacity 0.3s;">
                                <div class="row g-0">
                                    @if (!string.IsNullOrEmpty(imgUrl))
                                    {
                                        <div class="col-md-4">
                                            <img src="@imgUrl" class="img-fluid rounded-start" style="width: 100%; height: 200px; object-fit: cover;" alt="News Image">
                                        </div>
                                    }
                                    
                                    <div class="@(!string.IsNullOrEmpty(imgUrl) ? "col-md-8" : "col-md-12")">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <h5 class="card-title">
                                                    <!-- При клике помечаем как прочитанное -->
                                                    <a href="@item.Link" target="_blank" 
                                                       class="text-decoration-none @(isRead ? "text-secondary" : "text-dark fw-bold")"
                                                       @onclick="() => MarkAsRead(item.Id)">
                                                        @item.Title
                                                    </a>
                                                </h5>
                                                
                                                <!-- КНОПКА ЗАКЛАДКИ -->
                                                <button class="btn-bookmark ms-3 @(isBookmarked ? "active" : "")" 
                                                        @onclick="() => ToggleBookmark(item.Id)"
                                                        title="@(isBookmarked ? "Убрать из избранного" : "В избранное")">
                                                    <!-- SVG иконка звезды -->
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16">
                                                      <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                                    </svg>
                                                </button>
                                            </div>

                                            <h6 class="card-subtitle mb-2 text-muted">
                                                @item.Source?.Name 
                                                @if(item.Category != null)
                                                {
                                                    <span class="badge bg-secondary ms-2">@item.Category.Name</span>
                                                }
                                                <small class="ms-2">@item.PublishedDate.ToLocalTime().ToString("g")</small>
                                            </h6>
                                            
                                            <p class="card-text">
                                                @if (cleanDesc.Length > 200)
                                                {
                                                    @cleanDesc.Substring(0, 200) <span>...</span>
                                                }
                                                else
                                                {
                                                    @cleanDesc
                                                }
                                            </p>
                                            
                                            <a href="@item.Link" target="_blank" class="btn btn-sm btn-primary"
                                               @onclick="() => MarkAsRead(item.Id)">
                                               Читать далее →
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- МОДАЛЬНОЕ ОКНО -->
@if (showCategoryModal)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title fw-bold">Выберите тему</h5>
                        <small class="text-muted">
                            @if(currentMode == FeedMode.MyFeed) { <span>Только ваши подписки</span> }
                            else if(currentMode == FeedMode.BySource) { <span>Темы источника <strong>@(sources.FirstOrDefault(s=>s.Id==selectedSourceId)?.Name)</strong></span> }
                            else { <span>Все доступные темы</span> }
                        </small>
                    </div>
                    <button type="button" class="btn-close" @onclick="() => showCategoryModal = false"></button>
                </div>
                <div class="modal-body">
                    
                    @if (categoriesForModal.Count == 0)
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            Темы не найдены.
                        </div>
                    }
                    else
                    {
                        <!-- СЕТКА: 2 колонки на мобильном, 3 на компьютере -->
                        <div class="row row-cols-2 row-cols-md-3 g-2">
                            @foreach (var cat in categoriesForModal)
                            {
                                <div class="col">
                                    <button class="btn btn-light border w-100 text-start text-truncate @(currentMode == FeedMode.ByCategory && selectedCategoryId == cat.Id ? "active border-primary bg-primary text-white" : "")"
                                            @onclick="() => FilterByCategory(cat)"
                                            title="@cat.Name">
                                        @cat.Name
                                    </button>
                                </div>
                            }
                        </div>
                    }

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCategoryModal = false">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum FeedMode { MyFeed, AllNews, BySource, ByCategory, Favorites } // Добавили Favorites

    private FeedMode currentMode = FeedMode.MyFeed;
    private List<Article> articles;
    private List<Source> sources = new();
    private List<Category> allCategories = new();
    
    // --- НОВЫЕ ХЭШ-СЕТЫ ---
    private HashSet<int> bookmarkedArticleIds = new();
    private HashSet<int> readArticleIds = new();

    private int selectedSourceId;
    private int selectedCategoryId;
    private string selectedCategoryName = "";
    private HashSet<int> myInterestIds = new();
    private string currentUserId;
    private bool showCategoryModal = false;

    private List<Category> categoriesForModal = new(); 

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";

        await LoadInitialData();
        
        if (myInterestIds.Count == 0) currentMode = FeedMode.AllNews;
        
        await LoadNews();
    }

    private async Task PrepareAndOpenModal()
{
    categoriesForModal.Clear();
    using var context = DbFactory.CreateDbContext();

    // 1. ПРИНУДИТЕЛЬНО грузим категории заново (вдруг контекст старый)
    var allCats = await context.Categories.AsNoTracking().OrderBy(c => c.Name).ToListAsync();

    // Проверка-дебаг: если категорий вообще нет в базе
    if (allCats.Count == 0)
    {
        Console.WriteLine("ВНИМАНИЕ: Таблица Categories пуста!"); 
        // Тут можно добавить фейковую категорию для теста, если хочешь
        // allCats.Add(new Category { Id = 1, Name = "Тестовая категория" });
    }
        // 2. Фильтруем список в зависимости от режима
        if (currentMode == FeedMode.MyFeed)
        {
            // В "Моей ленте" показываем только то, на что подписан юзер
            categoriesForModal = allCats.Where(c => myInterestIds.Contains(c.Id)).ToList();
        }
        else if (currentMode == FeedMode.BySource)
        {
            // В режиме источника - ищем категории, связанные с этим источником
            // Используем простой запрос, чтобы не грузить базу
            var sourceCatIds = await context.Articles
                .Where(a => a.SourceId == selectedSourceId && a.CategoryId.HasValue)
                .Select(a => a.CategoryId.Value)
                .Distinct()
                .ToListAsync();

            categoriesForModal = allCats.Where(c => sourceCatIds.Contains(c.Id)).ToList();
        }
        else if (currentMode == FeedMode.Favorites)
        {
             // В избранном - категории из закладок
             var favCatIds = await context.Articles
                .Where(a => bookmarkedArticleIds.Contains(a.Id) && a.CategoryId.HasValue)
                .Select(a => a.CategoryId.Value)
                .Distinct()
                .ToListAsync();

             categoriesForModal = allCats.Where(c => favCatIds.Contains(c.Id)).ToList();
        }
        else 
        {
            // Режим "Все новости" (или любой другой) -> ПОКАЗЫВАЕМ ВСЁ
            // Но только те, в которых есть хоть какие-то статьи (чтобы не показывать мусор)
            var activeCatIds = await context.Articles
                .Where(a => a.CategoryId.HasValue)
                .Select(a => a.CategoryId.Value)
                .Distinct()
                .ToListAsync();
            
            categoriesForModal = allCats.Where(c => activeCatIds.Contains(c.Id)).ToList();
            
            // Если база пустая, покажем вообще все (на всякий случай)
            if (categoriesForModal.Count == 0) categoriesForModal = allCats;
        }

        showCategoryModal = true;
    }

    private async Task LoadInitialData()
    {
        using var context = DbFactory.CreateDbContext();
        sources = await context.Sources.ToListAsync();
        allCategories = await context.Categories.OrderBy(c => c.Name).ToListAsync();
        
        if (!string.IsNullOrEmpty(currentUserId))
        {
            myInterestIds = (await context.UserInterests
                .Where(ui => ui.UserId == currentUserId)
                .Select(ui => ui.CategoryId)
                .ToListAsync())
                .ToHashSet();

            // Загружаем закладки и историю прочитанного
            bookmarkedArticleIds = (await context.UserBookmarks
                .Where(b => b.UserId == currentUserId)
                .Select(b => b.ArticleId)
                .ToListAsync())
                .ToHashSet();

            readArticleIds = (await context.UserReadHistory
                .Where(h => h.UserId == currentUserId)
                .Select(h => h.ArticleId)
                .ToListAsync())
                .ToHashSet();
        }
    }

    // --- ЛОГИКА ЗАКЛАДОК ---
    private async Task ToggleBookmark(int articleId)
    {
        using var context = DbFactory.CreateDbContext();
        
        if (bookmarkedArticleIds.Contains(articleId))
        {
            // Удаляем
            var bm = await context.UserBookmarks
                .FirstOrDefaultAsync(b => b.UserId == currentUserId && b.ArticleId == articleId);
            if (bm != null) context.UserBookmarks.Remove(bm);
            bookmarkedArticleIds.Remove(articleId);
        }
        else
        {
            // Добавляем
            context.UserBookmarks.Add(new UserBookmark { UserId = currentUserId, ArticleId = articleId });
            bookmarkedArticleIds.Add(articleId);
        }
        
        await context.SaveChangesAsync();
    }

    // --- ЛОГИКА ПРОЧИТАННОГО ---
    private async Task MarkAsRead(int articleId)
    {
        // Если уже прочитано - ничего не делаем, чтобы не грузить базу
        if (readArticleIds.Contains(articleId)) return;

        using var context = DbFactory.CreateDbContext();
        context.UserReadHistory.Add(new UserReadHistory { UserId = currentUserId, ArticleId = articleId });
        await context.SaveChangesAsync();
        
        readArticleIds.Add(articleId); // Обновляем UI мгновенно
    }

    private async Task SetMode(FeedMode mode)
    {
        currentMode = mode;
        await LoadNews();
    }

    private async Task FilterBySource(int sourceId)
    {
        currentMode = FeedMode.BySource;
        selectedSourceId = sourceId;
        await LoadNews();
    }

    private async Task FilterByCategory(Category cat)
    {
        currentMode = FeedMode.ByCategory;
        selectedCategoryId = cat.Id;
        selectedCategoryName = cat.Name;
        showCategoryModal = false; 
        await LoadNews();
    }

    private async Task LoadNews()
    {
        using var context = DbFactory.CreateDbContext();
        IQueryable<Article> query = context.Articles
            .Include(a => a.Source)
            .Include(a => a.Category)
            .OrderByDescending(a => a.PublishedDate);

        switch (currentMode)
        {
            case FeedMode.MyFeed:
                if (myInterestIds.Any())
                    query = query.Where(a => a.CategoryId.HasValue && myInterestIds.Contains(a.CategoryId.Value));
                else
                    query = query.Where(a => false);
                break;

            case FeedMode.AllNews:
                break;

            case FeedMode.BySource:
                query = query.Where(a => a.SourceId == selectedSourceId);
                break;

            case FeedMode.ByCategory:
                query = query.Where(a => a.CategoryId == selectedCategoryId);
                break;

            case FeedMode.Favorites: // Фильтруем только избранное
                query = query.Where(a => bookmarkedArticleIds.Contains(a.Id));
                break;
        }

        articles = await query.Take(50).ToListAsync();
    }

    // --- УТИЛИТЫ ---
    private string GetImageUrl(string htmlDescription)
    {
        if (string.IsNullOrEmpty(htmlDescription)) return null;
        var match = Regex.Match(htmlDescription, "<img.+?src=[\"'](.+?)[\"'].*?>", RegexOptions.IgnoreCase);
        return match.Success ? match.Groups[1].Value : null;
    }

    private string GetCleanDescription(string htmlDescription)
    {
        if (string.IsNullOrEmpty(htmlDescription)) return "";
        var text = htmlDescription.Replace("<br>", " ").Replace("<br/>", " ");
        return Regex.Replace(text, "<.*?>", string.Empty);
    }

    private string GetTitle()
    {
        return currentMode switch
        {
            FeedMode.MyFeed => "❤️ Моя лента",
            FeedMode.AllNews => "🌍 Все новости",
            FeedMode.Favorites => "⭐ Избранные статьи",
            FeedMode.BySource => $"Источник: {sources.FirstOrDefault(s => s.Id == selectedSourceId)?.Name}",
            FeedMode.ByCategory => $"Категория: {selectedCategoryName}",
            _ => "Новости"
        };
    }
}
<style>
    /* Стиль для кнопки-звездочки */
    .btn-bookmark {
        border: none;
        background: none;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: #ccc; /* Цвет пустой звезды */
    }
    
    .btn-bookmark:hover {
        transform: scale(1.2); /* Увеличение при наведении */
        color: #ffc107; /* Желтый при наведении */
    }

    .btn-bookmark.active {
        color: #ffc107; /* Желтый, когда активно */
        transform: scale(1.1);
    }
    
    /* Анимация нажатия */
    .btn-bookmark:active {
        transform: scale(0.9);
    }

    /* Фиксированное меню */
    .sticky-sidebar {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto; /* Скролл внутри меню, если источников много */
    }

    /* Стили для модального окна */
    .category-group-title {
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: bold;
        margin-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 4px;
        margin-top: 16px;
    }
</style>
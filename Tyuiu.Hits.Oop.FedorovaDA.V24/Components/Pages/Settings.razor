@page "/settings"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using NewsAggregator.Data
@using NewsAggregator.Models
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

@attribute [Authorize]

<div class="container">
    <h3 class="mb-4">⚙️ Настройки ленты</h3>

    <div class="row">
        <!-- ЛЕВАЯ КОЛОНКА: Источники и их категории -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Мои подписки</h5>
                </div>
                <div class="card-body p-0">
                    <div class="accordion" id="sourcesAccordion">
                        @foreach (var group in sourceCategories)
                        {
                            var sourceName = group.Key;
                            var categories = group.Value;
                            var sourceIdString = "source-" + sourceName.GetHashCode(); // Уникальный ID для HTML

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@sourceIdString">
                                        <strong>@sourceName</strong>
                                        <span class="badge bg-secondary ms-2">@categories.Count тем</span>
                                    </button>
                                </h2>
                                <div id="@sourceIdString" class="accordion-collapse collapse" data-bs-parent="#sourcesAccordion">
                                    <div class="accordion-body">
                                        @if (categories.Count == 0)
                                        {
                                            <p class="text-muted small">Категории еще не найдены. Подождите, пока парсер скачает новости.</p>
                                        }
                                        else
                                        {
                                            <div class="d-flex flex-wrap gap-3">
                                                @foreach (var cat in categories)
                                                {
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="cat-@cat.Id"
                                                               checked="@myInterestIds.Contains(cat.Id)"
                                                               @onchange="@(async (ChangeEventArgs e) => await ToggleInterest(cat.Id, e.Value))">
                                                        <label class="form-check-label" for="cat-@cat.Id">@cat.Name</label>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (orphanCategories.Any())
                        {
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#orphans">
                                        Прочие категории
                                    </button>
                                </h2>
                                <div id="orphans" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        @foreach (var cat in orphanCategories)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       checked="@myInterestIds.Contains(cat.Id)"
                                                       @onchange="@(async (ChangeEventArgs e) => await ToggleInterest(cat.Id, e.Value))">
                                                <label class="form-check-label">@cat.Name</label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Добавить новый сайт</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="newSource" OnValidSubmit="AddSource" FormName="add-source">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Название сайта</label>
                            <InputText @bind-Value="newSource.Name" class="form-control" placeholder="Например: Хабр" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">RSS Ссылка</label>
                            <InputText @bind-Value="newSource.RssUrl" class="form-control" placeholder="https://..." />
                            <div class="form-text">Скопируйте сюда ссылку на RSS-ленту сайта.</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Подключить источник</button>
                    </EditForm>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <small>💡 <strong>Совет:</strong> После добавления нового сайта подождите пару минут. Парсер должен скачать новости, чтобы появились категории для выбора.</small>
            </div>
        </div>
    </div>
</div>

@code {
    // Группировка: Имя Источника -> Список Категорий
    private Dictionary<string, List<Category>> sourceCategories = new();
    private List<Category> orphanCategories = new(); 

    private HashSet<int> myInterestIds = new();
    private Source newSource = new();
    private string currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";
        await LoadData();
    }

    private async Task LoadData()
    {
        using var context = DbFactory.CreateDbContext();

        // Загружаем все источники
        var sources = await context.Sources.ToListAsync();

        // Загружаем категории
        var allCats = await context.Categories.ToListAsync();

        // узнаем, к какому источнику относится категория
        // Для этого смотрим на самую свежую статью в этой категории
        sourceCategories.Clear();
        orphanCategories.Clear();

        // Инициализируем группы для всех источников (даже пустых)
        foreach (var s in sources)
        {
            sourceCategories[s.Name] = new List<Category>();
        }

        foreach (var cat in allCats)
        {
            // Ищем любую статью этой категории, чтобы узнать источник
            var article = await context.Articles
                .Where(a => a.CategoryId == cat.Id)
                .Include(a => a.Source)
                .FirstOrDefaultAsync();

            if (article != null && article.Source != null)
            {
                if (sourceCategories.ContainsKey(article.Source.Name))
                {
                    sourceCategories[article.Source.Name].Add(cat);
                }
            }
            else
            {
                orphanCategories.Add(cat);
            }
        }

        // Загружаем интересы пользователя
        if (!string.IsNullOrEmpty(currentUserId))
        {
            myInterestIds = (await context.UserInterests
                .Where(ui => ui.UserId == currentUserId)
                .Select(ui => ui.CategoryId)
                .ToListAsync())
                .ToHashSet();
        }
    }

    private async Task ToggleInterest(int catId, object? isChecked)
    {
        bool check = (bool)(isChecked ?? false);
        using var context = DbFactory.CreateDbContext();

        if (check)
        {
            if (!await context.UserInterests.AnyAsync(ui => ui.UserId == currentUserId && ui.CategoryId == catId))
            {
                context.UserInterests.Add(new UserInterest { UserId = currentUserId, CategoryId = catId });
            }
        }
        else
        {
            var interest = await context.UserInterests
                .FirstOrDefaultAsync(ui => ui.UserId == currentUserId && ui.CategoryId == catId);
            if (interest != null) context.UserInterests.Remove(interest);
        }

        await context.SaveChangesAsync();
        if (check) myInterestIds.Add(catId);
        else myInterestIds.Remove(catId);
    }

    private async Task AddSource()
    {
        if (string.IsNullOrWhiteSpace(newSource.Name) || string.IsNullOrWhiteSpace(newSource.RssUrl)) return;

        using var context = DbFactory.CreateDbContext();
        if (!await context.Sources.AnyAsync(s => s.RssUrl == newSource.RssUrl))
        {
            context.Sources.Add(newSource);
            await context.SaveChangesAsync();
        }
        newSource = new Source();
        Nav.NavigateTo("/", true); // Полная перезагрузка, чтобы запустить парсер (если нужно)
    }
}
